<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" />
  <title>Derm Routine Tracker</title>

  <style>
    :root{
      /* Pastel palette */
      --bg: #0b1220;

      --day-bg: #FFF6D6;          /* pastel yellow */
      --day-card: rgba(255,255,255,.70);
      --day-text: #1a2230;
      --day-muted: rgba(26,34,48,.65);
      --day-border: rgba(26,34,48,.12);

      --night-bg: #0F1B2E;        /* muted navy */
      --night-card: rgba(255,255,255,.06);
      --night-text: #E8EEF8;
      --night-muted: rgba(232,238,248,.70);
      --night-border: rgba(255,255,255,.10);

      --accent: #7AA7FF;          /* soft pastel blue */
      --accent2: #73E6C4;         /* soft mint */
      --warn: #FFD38A;            /* soft peach */
      --danger: #FF9FB0;          /* soft pink */

      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.20);

      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; font-family: var(--font); }
    body{ margin:0; background: linear-gradient(180deg,#050812, #0b1220 40%, #050812); color:#e5e7eb; }

    header{
      position:sticky; top:0; z-index:5;
      padding:14px 16px 12px;
      background: rgba(5,8,18,.90);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color: rgba(229,231,235,.72); font-size:12.5px; line-height:1.35; }

    main{ max-width: 980px; margin:0 auto; padding: 14px 16px 90px; }

    /* Tabs + soft animation */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .tab{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      cursor:pointer; font-weight:750; font-size:12.5px;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .tab:active{ transform: scale(.98); }
    .tab.active{
      border-color: rgba(122,167,255,.55);
      background: rgba(122,167,255,.20);
    }

    /* Minimal mode toggle (header right) */
    .toggle{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: rgba(229,231,235,.85);
      user-select:none;
    }
    .switch{
      width:42px; height:22px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      position:relative;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .switch::after{
      content:"";
      width:18px; height:18px;
      border-radius:50%;
      background: rgba(255,255,255,.85);
      position:absolute; top:1px; left:1px;
      transition: transform .20s ease;
    }
    .switch.on{
      background: rgba(115,230,196,.20);
      border-color: rgba(115,230,196,.35);
    }
    .switch.on::after{ transform: translateX(20px); }

    /* Status pills */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.75);
      font-size:12px;
    }
    .pill strong{ color:#e5e7eb; }

    /* Views with animation */
    .view{
      opacity:0;
      transform: translateY(6px);
      transition: opacity .22s ease, transform .22s ease;
      will-change: opacity, transform;
      display:none;
    }
    .view.active{
      opacity:1;
      transform: translateY(0);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    @media (min-width:820px){ .grid{ grid-template-columns: 1fr 1fr; } }

    /* Day/Night section styling */
    .section{
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.08);
    }
    .sectionHeader{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:850;
      letter-spacing:.2px;
    }
    .sectionBody{
      padding:14px;
    }

    .day .sectionHeader{
      background: rgba(255, 220, 120, .35);
      color: var(--day-text);
      border-bottom:1px solid var(--day-border);
    }
    .day{
      background: var(--day-bg);
      color: var(--day-text);
    }
    .day .muted{ color: var(--day-muted); }
    .day .item{ border-top:1px solid var(--day-border); }
    .day input[type="checkbox"]{ accent-color: #5E8FFF; }
    .day .noteBox, .day textarea, .day input[type="date"], .day select{
      background: rgba(255,255,255,.72);
      border:1px solid var(--day-border);
      color: var(--day-text);
    }

    .night .sectionHeader{
      background: rgba(122,167,255,.18);
      color: var(--night-text);
      border-bottom:1px solid var(--night-border);
    }
    .night{
      background: var(--night-bg);
      color: var(--night-text);
    }
    .night .muted{ color: var(--night-muted); }
    .night .item{ border-top:1px solid var(--night-border); }
    .night input[type="checkbox"]{ accent-color: #7AA7FF; }
    .night .noteBox, .night textarea, .night input[type="date"], .night select{
      background: rgba(255,255,255,.06);
      border:1px solid var(--night-border);
      color: var(--night-text);
    }

    /* Cards (neutral) */
    .card{
      background: rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 10px; font-size:14px; }
    .card h3{ margin:12px 0 8px; font-size:13px; }

    .muted{ color: rgba(229,231,235,.70); font-size:12px; line-height:1.35; }
    .small{ font-size:11.5px; color: rgba(229,231,235,.70); }

    /* Checklist items */
    .item{ display:flex; align-items:flex-start; gap:10px; padding:10px 0; }
    .item:first-of-type{ border-top:none; padding-top:0; }
    input[type="checkbox"]{ width:18px; height:18px; margin-top:2px; }

    .label{ flex:1; }
    .tline{ display:flex; align-items:center; gap:8px; }
    .t{ font-size:13.5px; font-weight:850; }
    .d{ font-size:12px; margin-top:4px; line-height:1.3; }

    /* Info icon + tooltip */
    .info{
      width:18px; height:18px;
      border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:12px; font-weight:900;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: inherit;
      opacity:.9;
    }
    .tooltip{
      display:none;
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      font-size:12px;
      line-height:1.35;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
    }
    .day .tooltip{
      border:1px solid var(--day-border);
      background: rgba(255,255,255,.58);
      color: var(--day-text);
    }
    .night .tooltip{
      border:1px solid var(--night-border);
      background: rgba(255,255,255,.06);
      color: var(--night-text);
    }

    /* Actions */
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:none; border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:850;
      background: rgba(255,255,255,.08);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.10);
      font-size:12.5px;
      transition: transform .15s ease, background .15s ease;
    }
    button:active{ transform: scale(.98); }
    button.primary{ background: rgba(122,167,255,.20); border-color: rgba(122,167,255,.35); }
    button.good{ background: rgba(115,230,196,.14); border-color: rgba(115,230,196,.30); }
    button.warn{ background: rgba(255,211,138,.14); border-color: rgba(255,211,138,.30); }
    button.danger{ background: rgba(255,159,176,.14); border-color: rgba(255,159,176,.30); }

    /* Inputs */
    textarea, input[type="date"], select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }

    .split{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:820px){ .split{ grid-template-columns:1fr 1fr; } }

    /* Summary chips + progress */
    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: rgba(229,231,235,.75);
    }
    .chip strong{ color:#e5e7eb; }
    .progressWrap{ margin-top:10px; }
    .progressBar{
      height:10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,167,255,.55), rgba(115,230,196,.50));
      transition: width .25s ease;
    }

    /* Pre-start banner */
    .banner{
      margin-top:12px;
      border-radius: var(--radius);
      padding:12px;
      border:1px solid rgba(255,211,138,.35);
      background: rgba(255,211,138,.12);
      color:#ffe8bb;
    }
    .banner strong{ color:#ffe0a5; }

    /* Minimal mode: hide descriptions + tooltips + notes body */
    body.minimal .d,
    body.minimal .tooltip,
    body.minimal .notesCard .muted,
    body.minimal .notesCard textarea{
      display:none !important;
    }
    body.minimal .notesCard .actions{
      margin-top:0;
    }

    .hr{ height:1px; background: rgba(255,255,255,.08); margin:12px 0; }

    /* Replacements list */
    .list{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .alt{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.05);
    }
    .alt .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .alt .name{ font-weight:900; font-size:13px; }
    .alt .desc{ margin-top:6px; color: rgba(229,231,235,.70); font-size:12px; line-height:1.35; }
    .meta{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color: rgba(229,231,235,.75);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tag.good{ border-color: rgba(115,230,196,.28); background: rgba(115,230,196,.12); color:#c9ffef; }
    .tag.warn{ border-color: rgba(255,211,138,.28); background: rgba(255,211,138,.12); color:#fff0cf; }
  </style>
</head>

<body>
<header>
  <h1>Derm Routine Tracker</h1>
  <div class="sub">
    Built for: stable melasma (cheeks/upper lip/forehead), hormonal breakouts, tretinoin ramp-up, HQ taper.
    Data stays on this device (localStorage).
  </div>

  <div class="tabs" id="tabs">
    <!-- tabs injected -->
    <div class="toggle" title="Minimal mode hides descriptions and notes text area">
      Minimal
      <div id="minimalSwitch" class="switch" role="switch" aria-checked="false"></div>
    </div>
  </div>
</header>

<main>
  <div class="row" id="statusRow"></div>
  <div id="preStartBanner"></div>

  <!-- TODAY -->
  <section id="view-today" class="view">
    <div class="card">
      <h2>Today summary</h2>
      <div class="chipRow" id="summaryChips"></div>
      <div class="progressWrap">
        <div class="small" id="progressLabel">Progress: 0%</div>
        <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
      </div>
      <div class="actions">
        <button class="good" id="markAM">Mark AM done</button>
        <button class="good" id="markPM">Mark PM done</button>
        <button id="clearToday">Clear today</button>
      </div>
    </div>

    <div class="grid">
      <div class="section day" id="amSection"></div>
      <div class="section night" id="pmSection"></div>
    </div>

    <div class="card notesCard" style="margin-top:12px;">
      <h2>Notes</h2>
      <div class="muted">Track irritation, flaking, melasma changes, pimples, sun/heat exposure, cycle timing, etc.</div>
      <textarea id="notes" placeholder="Example: slight flaking around nose; no melasma darkening; 1 hormonal pimple on chin."></textarea>
      <div class="actions">
        <button class="primary" id="saveNotes">Save notes</button>
        <button id="clearNotes">Clear notes</button>
      </div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="view-plan" class="view">
    <div class="card">
      <h2>Plan settings</h2>

      <div class="split">
        <div>
          <div class="small">Protocol start date (Night 1 = Tretinoin)</div>
          <input type="date" id="startDate" />
        </div>
        <div>
          <div class="small">HQ taper phase</div>
          <select id="hqPhase">
            <option value="phase1">Phase 1 (Month 1): HQ 3 mornings/week</option>
            <option value="phase2">Phase 2 (Month 2): HQ 2 mornings/week</option>
            <option value="phase3">Phase 3 (Month 3+): HQ OFF (maintenance)</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h3>HQ mornings (optional)</h3>
      <div class="muted">
        Pick exactly <strong>3</strong> days for Phase 1 (or <strong>2</strong> days for Phase 2).
        If you don’t pick days, the app will still show the general taper guidance.
      </div>
      <div class="chipRow" id="hqDayPicker"></div>
      <div class="small" id="hqDaysHint"></div>

      <div class="hr"></div>

      <div class="muted">
        <strong>Night rotation (4-night cycle):</strong>
        Night 1 = Tretinoin • Night 2 = Recovery • Night 3 = Azelaic • Night 4 = Recovery.
      </div>

      <div class="actions">
        <button class="primary" id="saveSettings">Save settings</button>
        <button class="danger" id="resetAll">Reset app data</button>
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section id="view-products" class="view">
    <div class="card" id="productCabinet"></div>
  </section>

  <!-- REPLACEMENTS -->
  <section id="view-alternatives" class="view">
    <div class="card" id="alternatives"></div>
  </section>
</main>

<script>
  // ---------------- State ----------------
  const DEFAULT = {
    settings: {
      rotationStart: new Date().toISOString().slice(0,10),
      hqPhase: "phase1",
      // optional: HQ days 0=Sun..6=Sat (leave empty to not enforce)
      hqDays: [1,3,5],
      minimalMode: false
    },
    activeProducts: {
      cleanser: "SkinMedica Facial Cleanser",
      vitaminC_HQ: "Obagi Vitamin C + 4% Hydroquinone (AM, tapered)",
      azelaic: "Prescription Azelaic Acid 15% (Finacea or generic)",
      moisturizerLight: "Seacra Marine Algae Gel",
      moisturizerBarrier: "SkinMedica Dermal Repair Cream (PM / retinoid nights)",
      sunscreen: "Eucerin SPF 50",
      tretinoin: "Tretinoin 0.025% cream (Rx)"
    },
    logs: {}
  };

  // Replacement library (compact but useful)
  const PRODUCT_LIBRARY = {
    cleanser: {
      primary: { name:"SkinMedica Facial Cleanser", tier:"$$", value:"High", note:"Gentle, retinoid-friendly cleanser." },
      alts: [
        { name:"La Roche-Posay Toleriane Hydrating Gentle Cleanser", tier:"$", value:"Very High", note:"Best cost/benefit; barrier-friendly." },
        { name:"CeraVe Hydrating Cleanser", tier:"$", value:"High", note:"Great value; very gentle if you get dry with tret." }
      ]
    },
    azelaic: {
      primary: { name:"Prescription Azelaic Acid 15% (Finacea or generic)", tier:"$$", value:"Very High", note:"Strong maintenance for melasma + hormonal acne." },
      alts: [
        { name:"Prescription Azelaic Acid 20% cream (generic)", tier:"$$", value:"Very High", note:"Stronger option; discuss with dermatologist." },
        { name:"The Ordinary Azelaic Acid 10% (OTC)", tier:"$", value:"High", note:"Budget option; typically less potent than Rx." }
      ]
    },
    tretinoin: {
      primary: { name:"Tretinoin 0.025% cream (Rx)", tier:"$$", value:"Very High", note:"Gold standard for collagen, texture, acne control." },
      alts: [
        { name:"Adapalene 0.1% gel (OTC)", tier:"$", value:"High", note:"Gentler retinoid alternative if needed." },
        { name:"Tretinoin 0.05% cream (Rx)", tier:"$$", value:"High", note:"Step-up after months of stability on 0.025%." }
      ]
    },
    moisturizerBarrier: {
      primary: { name:"SkinMedica Dermal Repair Cream", tier:"$$$", value:"High", note:"Barrier support for tret nights / dryness." },
      alts: [
        { name:"La Roche-Posay Cicaplast Balm B5+", tier:"$", value:"Very High", note:"Excellent cost/benefit for irritation and flaking." },
        { name:"Obagi Hydrate Luxe (PM)", tier:"$$$", value:"High", note:"Rich PM moisturizer; good if you prefer Obagi." }
      ]
    },
    moisturizerLight: {
      primary: { name:"Seacra Marine Algae Gel", tier:"$$", value:"Medium", note:"Light hydration layer; may not be enough alone with frequent tret." },
      alts: [
        { name:"Vanicream Daily Facial Moisturizer", tier:"$", value:"High", note:"Simple, low-irritant daily moisturizer." },
        { name:"CeraVe PM Facial Moisturizing Lotion", tier:"$", value:"High", note:"Light but barrier-supportive; solid value." }
      ]
    },
    sunscreen: {
      primary: { name:"Eucerin SPF 50", tier:"$", value:"High", note:"Non-negotiable for melasma stability." },
      alts: [
        { name:"EltaMD UV Clear SPF 46", tier:"$$", value:"High", note:"Popular for acne-prone + pigmentation-prone skin." },
        { name:"La Roche-Posay Anthelios SPF 50+", tier:"$$", value:"High", note:"Strong UV protection; multiple textures." }
      ]
    }
  };

  const TABS = [
    { id:"today", label:"Today" },
    { id:"plan", label:"Plan" },
    { id:"products", label:"Products" },
    { id:"alternatives", label:"Replacements" }
  ];

  const $ = (id)=>document.getElementById(id);

  function loadState(){
    try{
      const raw = localStorage.getItem("dermRoutineState");
      return raw ? JSON.parse(raw) : structuredClone(DEFAULT);
    } catch {
      return structuredClone(DEFAULT);
    }
  }
  function saveState(){
    localStorage.setItem("dermRoutineState", JSON.stringify(state));
  }

  let state = loadState();

  // ---------------- Helpers ----------------
  function todayISO(){
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  }

  function daysBetween(aISO, bISO){
    const a = new Date(aISO+"T00:00:00");
    const b = new Date(bISO+"T00:00:00");
    return Math.floor((b - a) / (1000*60*60*24));
  }

  function isBeforeStart(dateISO){
    return daysBetween(state.settings.rotationStart, dateISO) < 0;
  }

  function nightTypeFor(dateISO){
    if (isBeforeStart(dateISO)) return "Prep Mode";
    const delta = daysBetween(state.settings.rotationStart, dateISO);
    const mod = ((delta % 4) + 4) % 4;
    if(mod===0) return "Tretinoin Night";
    if(mod===2) return "Azelaic Night";
    return "Recovery Night";
  }

  function hqGuidance(){
    const p = state.settings.hqPhase;
    if(p==="phase1") return "HQ 3 mornings/week (Month 1 taper).";
    if(p==="phase2") return "HQ 2 mornings/week (Month 2 taper).";
    return "HQ OFF (maintenance).";
  }

  function weekdayNum(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    return d.getDay(); // 0 Sun..6 Sat
  }

  function isHQDay(dateISO){
    const phase = state.settings.hqPhase;
    if(phase==="phase3") return false;
    const days = state.settings.hqDays || [];
    if(!Array.isArray(days) || days.length===0) return null; // unknown / not set
    return days.includes(weekdayNum(dateISO));
  }

  function getLog(dateISO){
    state.logs[dateISO] ||= { am:{}, pm:{}, notes:"" };
    return state.logs[dateISO];
  }

  function setCheck(dateISO, slot, id, val){
    const log = getLog(dateISO);
    log[slot][id] = val;
    saveState();
    render();
  }

  function setNotes(dateISO, text){
    const log = getLog(dateISO);
    log.notes = text || "";
    saveState();
    render();
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeJs(str){
    return (str||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }
  function prettyKey(k){
    return k.replace(/_/g," ")
      .replace(/([A-Z])/g," $1")
      .replace(/\s+/g," ")
      .trim()
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  // ---------------- Educational “?” tooltips (brief) ----------------
  const INFO = {
    cleanse: "Removes sunscreen, oil, and debris without stripping. Prepares skin for active ingredients.",
    vitaminC: "Antioxidant protection + brightening + supports collagen. Helps prevent new pigment.",
    hydroquinone: "Temporarily suppresses pigment production in melasma-prone areas. Use in cycles/taper.",
    azelaic: "Calms inflammation, helps hormonal acne, and supports pigment stability (melasma-safe).",
    hydrate: "Adds hydration to reduce dryness and support tolerance to actives.",
    sunscreen: "Prevents UV-triggered melasma activation and collagen breakdown. Most important step.",
    tretinoin: "Gold standard for collagen + texture + acne control. Start slow to avoid irritation/pigment flare.",
    barrier: "Reinforces skin barrier to reduce irritation, flaking, and sensitivity from actives.",
    wait: "Applying tret to fully dry skin reduces irritation and helps tolerance."
  };

  // ---------------- Checklists ----------------
  function amChecklist(dateISO){
    const ap = state.activeProducts;
    const phase = state.settings.hqPhase;
    const hqDay = isHQDay(dateISO); // true/false/null

    const items = [
      { id:"am_cleanse", title:"Cleanse", desc: ap.cleanser, info: INFO.cleanse },
      { id:"am_vitc", title:"Vitamin C", desc: `${ap.vitaminC_HQ} (use Vitamin C component daily)`, info: INFO.vitaminC }
    ];

    if(phase !== "phase3"){
      // If HQ days are configured, label clearly
      let hqLabel = "Hydroquinone (tapered)";
      let hqDesc = `4% HQ: follow taper schedule. ${hqGuidance()}`;
      if(hqDay === true) {
        hqLabel = "Hydroquinone (HQ day)";
      } else if(hqDay === false) {
        hqLabel = "Hydroquinone (skip today)";
        hqDesc = "Today is a non-HQ morning (use Azelaic instead).";
      } else {
        hqLabel = "Hydroquinone (tapered)";
      }

      items.push({ id:"am_hq", title:hqLabel, desc:hqDesc, info: INFO.hydroquinone });

      // Azelaic mornings
      let azLabel = "Azelaic (non-HQ mornings)";
      let azDesc = `${ap.azelaic} — use on mornings you do NOT apply HQ.`;
      if(hqDay === true) {
        azLabel = "Azelaic (skip today)";
        azDesc = "Today is an HQ morning. Save Azelaic for non-HQ mornings or PM Azelaic night.";
      } else if(hqDay === false) {
        azLabel = "Azelaic (today)";
        azDesc = `${ap.azelaic} — thin layer.`;
      }
      items.push({ id:"am_azelaic", title:azLabel, desc:azDesc, info: INFO.azelaic });
    } else {
      items.push({ id:"am_azelaic", title:"Azelaic (maintenance)", desc:`${ap.azelaic} — daily or as tolerated.`, info: INFO.azelaic });
    }

    items.push(
      { id:"am_hydrate", title:"Hydration layer", desc: ap.moisturizerLight, info: INFO.hydrate },
      { id:"am_spf", title:"Sunscreen", desc: `${ap.sunscreen} — apply generously (2 finger lengths).`, info: INFO.sunscreen }
    );

    return items;
  }

  function pmChecklist(dateISO){
    const ap = state.activeProducts;
    const nt = nightTypeFor(dateISO);

    if (nt === "Prep Mode") {
      return {
        nightType: "Prep Mode (before start date)",
        items: [
          { id:"pm_cleanse", title:"Cleanse", desc: ap.cleanser, info: INFO.cleanse },
          { id:"pm_recovery", title:"Moisturize", desc: `Use ${ap.moisturizerLight} (and barrier cream if dry). No tret until start date.`, info: INFO.barrier }
        ]
      };
    }

    const items = [
      { id:"pm_cleanse", title:"Cleanse", desc: ap.cleanser, info: INFO.cleanse },
    ];

    if(nt==="Tretinoin Night"){
      items.push(
        { id:"pm_wait", title:"Wait 20 minutes", desc:"Let skin fully dry to reduce irritation.", info: INFO.wait },
        { id:"pm_tret", title:"Tretinoin (pea-size)", desc:`${ap.tretinoin} — avoid corners of nose/mouth/eyes. Buffer if needed.`, info: INFO.tretinoin },
        { id:"pm_barrier", title:"Barrier moisturizer", desc:`${ap.moisturizerBarrier} (or layer over ${ap.moisturizerLight})`, info: INFO.barrier }
      );
    } else if(nt==="Azelaic Night"){
      items.push(
        { id:"pm_azelaic", title:"Azelaic Acid", desc:`${ap.azelaic} — thin layer.`, info: INFO.azelaic },
        { id:"pm_moist", title:"Moisturize", desc:`${ap.moisturizerBarrier} (or ${ap.moisturizerLight} if you’re not dry).`, info: INFO.barrier }
      );
    } else {
      items.push(
        { id:"pm_recovery", title:"Recovery night", desc:`Moisturize only. Use ${ap.moisturizerBarrier} if dry/flaky; otherwise ${ap.moisturizerLight}.`, info: INFO.barrier }
      );
    }

    return { nightType: nt, items };
  }

  // ---------------- UI: Tabs + animation ----------------
  function renderTabs(active){
    const tabsEl = $("tabs");
    // Preserve the minimal toggle at the end
    const toggleEl = tabsEl.querySelector(".toggle");
    tabsEl.innerHTML = "";

    TABS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (active===t.id ? " active" : "");
      b.textContent = t.label;
      b.onclick = ()=>showView(t.id);
      tabsEl.appendChild(b);
    });

    tabsEl.appendChild(toggleEl);
  }

  function showView(id){
    const views = ["today","plan","products","alternatives"];
    views.forEach(v=>{
      const el = document.querySelector("#view-"+v);
      if(v===id){
        el.style.display = "";
        requestAnimationFrame(()=>el.classList.add("active"));
      } else {
        el.classList.remove("active");
        // Let animation finish before display none
        setTimeout(()=>{ el.style.display = "none"; }, 180);
      }
    });
    renderTabs(id);
  }

  // ---------------- UI: Theme hinting (pastel differentiation already applied per section) ----------------
  function renderStatus(dateISO){
    const night = nightTypeFor(dateISO);
    const row = $("statusRow");
    row.innerHTML = "";

    const pills = [
      { label:"Date:", val: dateISO },
      { label:"Tonight:", val: night },
      { label:"HQ:", val: hqGuidance() }
    ];

    // Optional explicit HQ day label if days selected
    const hq = isHQDay(dateISO);
    if(hq === true) pills.push({ label:"AM:", val:"HQ day" });
    if(hq === false) pills.push({ label:"AM:", val:"Azelaic day" });

    pills.forEach(p=>{
      const div = document.createElement("div");
      div.className="pill";
      div.innerHTML = `${p.label} <strong>${escapeHtml(p.val)}</strong>`;
      row.appendChild(div);
    });

    // Pre-start banner
    const pre = $("preStartBanner");
    if(isBeforeStart(dateISO)){
      pre.innerHTML = `
        <div class="banner">
          <strong>Prep mode:</strong> Your protocol starts <strong>${escapeHtml(state.settings.rotationStart)}</strong>.
          Until then: keep mornings consistent (Vitamin C + sunscreen) and nights gentle (moisturize only).
        </div>
      `;
    } else {
      pre.innerHTML = "";
    }
  }

  // ---------------- Rendering: Checklist with “?” icons ----------------
  function renderChecklist(container, headerTitle, items, slot, dateISO, sectionType /* day/night */){
    const log = getLog(dateISO);
    const checked = log[slot] || {};

    const header = document.createElement("div");
    header.className = "sectionHeader";
    header.innerHTML = `<div>${escapeHtml(headerTitle)}</div><div class="small">${slot.toUpperCase()}</div>`;

    const body = document.createElement("div");
    body.className = "sectionBody";

    items.forEach((it, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "item";
      if(idx === 0) wrap.style.borderTop = "none";

      const cb = document.createElement("input");
      cb.type="checkbox";
      cb.checked = !!checked[it.id];
      cb.onchange = ()=>setCheck(dateISO, slot, it.id, cb.checked);

      const lab = document.createElement("div");
      lab.className="label";

      const infoId = `${slot}_${it.id}_info`;

      lab.innerHTML = `
        <div class="tline">
          <div class="t">${escapeHtml(it.title)}</div>
          <div class="info" role="button" aria-label="What does this do?" onclick="toggleInfo('${escapeJs(infoId)}')">?</div>
        </div>
        <div class="d">${escapeHtml(it.desc)}</div>
        <div id="${escapeHtml(infoId)}" class="tooltip">${escapeHtml(it.info || "")}</div>
      `;

      wrap.appendChild(cb);
      wrap.appendChild(lab);
      body.appendChild(wrap);
    });

    container.innerHTML = "";
    container.className = `section ${sectionType}`;
    container.appendChild(header);
    container.appendChild(body);
  }

  window.toggleInfo = function(id){
    const el = document.getElementById(id);
    if(!el) return;
    // Minimal mode hides tooltips entirely
    if(document.body.classList.contains("minimal")) return;

    el.style.display = (el.style.display === "block") ? "none" : "block";
  };

  // ---------------- Summary + Progress ----------------
  function calcProgress(dateISO){
    const log = getLog(dateISO);
    const amItems = amChecklist(dateISO);
    const pm = pmChecklist(dateISO);
    const pmItems = pm.items;

    const total = amItems.length + pmItems.length;
    let done = 0;

    amItems.forEach(i=>{ if(log.am[i.id]) done++; });
    pmItems.forEach(i=>{ if(log.pm[i.id]) done++; });

    const pct = total ? Math.round((done/total)*100) : 0;
    return { pct, done, total, amItems, pmItems };
  }

  function renderSummary(dateISO){
    const chips = $("summaryChips");
    chips.innerHTML = "";

    const night = nightTypeFor(dateISO);
    const hq = isHQDay(dateISO);

    const chipData = [
      { label:"AM", val: hq===true ? "HQ day" : (hq===false ? "Azelaic day" : "Taper guidance") },
      { label:"PM", val: night },
      { label:"Start", val: state.settings.rotationStart }
    ];

    chipData.forEach(c=>{
      const div = document.createElement("div");
      div.className = "chip";
      div.innerHTML = `${escapeHtml(c.label)}: <strong>${escapeHtml(c.val)}</strong>`;
      chips.appendChild(div);
    });

    const { pct } = calcProgress(dateISO);
    $("progressLabel").textContent = `Progress: ${pct}%`;
    $("progressFill").style.width = `${pct}%`;
  }

  // ---------------- Plan: HQ day picker ----------------
  const DAY_LABELS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function renderHQPicker(){
    const wrap = $("hqDayPicker");
    wrap.innerHTML = "";

    const selected = new Set(state.settings.hqDays || []);
    DAY_LABELS.forEach((d, idx)=>{
      const btn = document.createElement("button");
      btn.type="button";
      btn.className = "chip";
      btn.style.cursor = "pointer";
      btn.innerHTML = `${d} ${selected.has(idx) ? "✓" : ""}`;
      btn.onclick = ()=>{
        const s = new Set(state.settings.hqDays || []);
        if(s.has(idx)) s.delete(idx); else s.add(idx);
        state.settings.hqDays = Array.from(s).sort((a,b)=>a-b);
        saveState();
        render();
      };
      wrap.appendChild(btn);
    });

    const phase = state.settings.hqPhase;
    const needed = (phase==="phase1") ? 3 : (phase==="phase2") ? 2 : 0;
    const count = (state.settings.hqDays || []).length;

    let hint = "";
    if(needed === 0) hint = "HQ is off in Phase 3. Day selection doesn’t matter.";
    else hint = `Selected ${count} day(s). Recommended: select exactly ${needed} for this phase.`;

    $("hqDaysHint").textContent = hint;
  }

  // ---------------- Products + Replacements ----------------
  function renderProducts(){
    const c = $("productCabinet");
    const ap = state.activeProducts;

    c.innerHTML = `
      <h2>Product cabinet (active picks)</h2>
      <div class="muted">Use “Replacements” to swap products. Your Today checklists update automatically.</div>
      <div class="hr"></div>
      <div class="list">
        ${Object.entries(ap).map(([k,v])=>`
          <div class="alt">
            <div class="top">
              <div>
                <div class="name">${escapeHtml(prettyKey(k))}</div>
                <div class="desc">${escapeHtml(v)}</div>
              </div>
              <div class="meta">
                <span class="tag">${escapeHtml(k.includes("moisturizerBarrier") ? "$$$" : "$$/$")}</span>
              </div>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="hr"></div>
      <div class="muted">
        <strong>Moisturizer note:</strong> Seacra Marine Algae is a great hydration layer, but many people need a barrier cream once tret frequency increases.
      </div>
    `;
  }

  function isActive(catKey, name){
    const map = {
      cleanser: "cleanser",
      azelaic: "azelaic",
      tretinoin: "tretinoin",
      moisturizerBarrier: "moisturizerBarrier",
      moisturizerLight: "moisturizerLight",
      sunscreen: "sunscreen"
    };
    const k = map[catKey];
    return k ? state.activeProducts[k] === name : false;
  }

  window.swapProduct = function(catKey, name){
    const map = {
      cleanser: "cleanser",
      azelaic: "azelaic",
      tretinoin: "tretinoin",
      moisturizerBarrier: "moisturizerBarrier",
      moisturizerLight: "moisturizerLight",
      sunscreen: "sunscreen"
    };
    const k = map[catKey];
    if(!k) return;
    state.activeProducts[k] = name;
    saveState();
    render();
    showView("products");
  };

  function renderAltCard(catKey, obj, isPrimary){
    const active = isActive(catKey, obj.name);
    const primaryTag = isPrimary ? `<span class="tag good">Primary</span>` : `<span class="tag">Alt</span>`;
    const activeTag = active ? `<span class="tag good">Active</span>` : "";
    const valueClass = (obj.value||"").includes("Very") ? "good" : "warn";

    const btn = active
      ? `<button disabled style="opacity:.55;cursor:not-allowed;">Active</button>`
      : `<button class="primary" onclick="swapProduct('${escapeJs(catKey)}','${escapeJs(obj.name)}')">Swap</button>`;

    return `
      <div class="alt">
        <div class="top">
          <div>
            <div class="name">${escapeHtml(obj.name)}</div>
            <div class="desc">${escapeHtml(obj.note || "")}</div>
          </div>
          <div class="meta">
            ${primaryTag}
            ${activeTag}
            <span class="tag">${escapeHtml(obj.tier || "$")}</span>
            <span class="tag ${valueClass}">Value: ${escapeHtml(obj.value || "—")}</span>
            ${btn}
          </div>
        </div>
      </div>
    `;
  }

  function renderAlternatives(){
    const c = $("alternatives");
    c.innerHTML = `
      <h2>Replacements (cost/benefit)</h2>
      <div class="muted">Swap options anytime. “Value” is practical cost/benefit (not medical advice). Rx coverage varies.</div>
      <div class="hr"></div>
    `;

    Object.keys(PRODUCT_LIBRARY).forEach(cat=>{
      const block = document.createElement("div");
      block.innerHTML = `
        <h3>${escapeHtml(prettyKey(cat))}</h3>
        <div class="list">
          ${renderAltCard(cat, PRODUCT_LIBRARY[cat].primary, true)}
          ${(PRODUCT_LIBRARY[cat].alts || []).map(a=>renderAltCard(cat, a, false)).join("")}
        </div>
        <div class="hr"></div>
      `;
      c.appendChild(block);
    });
  }

  // ---------------- Minimal mode ----------------
  function applyMinimalMode(){
    const on = !!state.settings.minimalMode;
    document.body.classList.toggle("minimal", on);
    const sw = $("minimalSwitch");
    sw.classList.toggle("on", on);
    sw.setAttribute("aria-checked", on ? "true" : "false");
  }

  function toggleMinimal(){
    state.settings.minimalMode = !state.settings.minimalMode;
    saveState();
    applyMinimalMode();
  }

  // ---------------- Wire events ----------------
  function wireEvents(dateISO){
    $("minimalSwitch").onclick = toggleMinimal;

    $("saveNotes").onclick = ()=> setNotes(dateISO, $("notes").value || "");
    $("clearNotes").onclick = ()=> setNotes(dateISO, "");

    $("saveSettings").onclick = ()=>{
      state.settings.rotationStart = $("startDate").value || todayISO();
      state.settings.hqPhase = $("hqPhase").value || "phase1";

      // Optional: enforce day count gently (do not block)
      saveState();
      render();
      showView("today");
    };

    $("resetAll").onclick = ()=>{
      if(confirm("Reset all saved routine data on this device?")){
        localStorage.removeItem("dermRoutineState");
        state = structuredClone(DEFAULT);
        saveState();
        render();
        showView("today");
      }
    };

    $("markAM").onclick = ()=>{
      const log = getLog(dateISO);
      amChecklist(dateISO).forEach(i=>{ log.am[i.id] = true; });
      saveState();
      render();
    };

    $("markPM").onclick = ()=>{
      const log = getLog(dateISO);
      pmChecklist(dateISO).items.forEach(i=>{ log.pm[i.id] = true; });
      saveState();
      render();
    };

    $("clearToday").onclick = ()=>{
      state.logs[dateISO] = { am:{}, pm:{}, notes: (getLog(dateISO).notes || "") };
      saveState();
      render();
    };
  }

  // ---------------- Render ----------------
  function renderPlan(){
    $("startDate").value = state.settings.rotationStart;
    $("hqPhase").value = state.settings.hqPhase;
    renderHQPicker();
  }

  function renderToday(dateISO){
    renderStatus(dateISO);
    renderSummary(dateISO);

    // AM section
    renderChecklist(
      $("amSection"),
      "Morning (AM)",
      amChecklist(dateISO),
      "am",
      dateISO,
      "day"
    );

    // PM section
    const pm = pmChecklist(dateISO);
    renderChecklist(
      $("pmSection"),
      `Night (PM) • ${pm.nightType}`,
      pm.items,
      "pm",
      dateISO,
      "night"
    );

    // Notes
    $("notes").value = getLog(dateISO).notes || "";
  }

  function render(){
    applyMinimalMode();

    const dateISO = todayISO();
    renderToday(dateISO);
    renderPlan();
    renderProducts();
    renderAlternatives();
    wireEvents(dateISO);

    // Update progress after all checks
    const { pct } = calcProgress(dateISO);
    $("progressLabel").textContent = `Progress: ${pct}%`;
    $("progressFill").style.width = `${pct}%`;
  }

  // Register service worker (offline)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }

  // Init
  renderTabs("today");
  showView("today");
  render();
</script>
</body>
</html>
