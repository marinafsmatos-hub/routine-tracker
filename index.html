<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" />
  <title>Routine ‚ú®</title>

  <style>
    :root{
      /* Pastel wellness palette */
      --ink:#1b2430;
      --muted: rgba(27,36,48,.65);
      --card: rgba(255,255,255,.72);
      --card2: rgba(255,255,255,.55);
      --border: rgba(27,36,48,.10);
      --shadow: 0 14px 40px rgba(15, 23, 42, .12);
      --shadow2: 0 10px 25px rgba(15, 23, 42, .10);
      --r: 20px;

      /* Morning gradient */
      --am1:#FFE7D1;  /* peach */
      --am2:#FFF2B8;  /* buttery yellow */
      --am3:#FFF9E7;  /* cream */

      /* Night gradient */
      --pm1:#DCD7FF;  /* lavender */
      --pm2:#B9D6FF;  /* periwinkle */
      --pm3:#243A63;  /* muted navy */

      /* Accents */
      --mint:#B9F3E4;
      --sky:#C6D8FF;
      --coral:#FFB3C6;
      --sun:#FFD38A;
      --violet:#B8A8FF;

      --btn:#1b2430;
      --btnText:#ffffff;
      --good:#2bb673;
      --warn:#f5a623;

      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, system-ui;
    }

    *{ box-sizing:border-box; font-family: var(--font); }
    body{
      margin:0;
      color:var(--ink);
      background: linear-gradient(135deg, var(--am1), var(--am2), var(--am3));
      min-height:100vh;
    }

    /* App shell */
    header{
      position:sticky; top:0; z-index:10;
      padding: 14px 14px 10px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(27,36,48,.08);
    }
    .topRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      max-width: 980px; margin: 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .logoDot{
      width:14px; height:14px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--mint), var(--sky));
      box-shadow: 0 0 0 6px rgba(185,243,228,.25);
    }
    .subtitle{
      margin-top:6px;
      max-width: 980px; margin-left:auto; margin-right:auto;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
      padding: 0 2px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      max-width: 980px; margin: 10px auto 0;
    }
    .tab{
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.55);
      color: var(--ink);
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 12.5px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .tab:active{ transform: scale(.98); }
    .tab.active{
      border-color: rgba(27,36,48,.18);
      background: rgba(255,255,255,.82);
    }

    /* Minimal toggle */
    .toggle{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.55);
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .switch{
      width:44px; height:24px; border-radius:999px;
      border: 1px solid rgba(27,36,48,.12);
      background: rgba(27,36,48,.06);
      position:relative;
      cursor:pointer;
      transition: background .18s ease, border-color .18s ease;
    }
    .switch::after{
      content:"";
      width:20px; height:20px; border-radius:50%;
      background: rgba(255,255,255,.95);
      position:absolute; top:1px; left:1px;
      box-shadow: 0 6px 14px rgba(15,23,42,.14);
      transition: transform .18s ease;
    }
    .switch.on{
      background: rgba(185,243,228,.65);
      border-color: rgba(43,182,115,.30);
    }
    .switch.on::after{ transform: translateX(20px); }

    main{ max-width: 980px; margin: 0 auto; padding: 14px 14px 90px; }

    /* Views + animation */
    .view{ display:none; opacity:0; transform: translateY(8px); transition: opacity .22s ease, transform .22s ease; }
    .view.active{ opacity:1; transform: translateY(0); }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.70);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card.soft{
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow2);
    }
    .h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .muted{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:820px){ .grid2{ grid-template-columns: 1fr 1fr; } }

    /* Big banner */
    .hero{
      border-radius: calc(var(--r) + 6px);
      padding: 14px;
      border: 1px solid rgba(255,255,255,.75);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      background: radial-gradient(circle at 20% 10%, rgba(185,243,228,.55), transparent 45%),
                  radial-gradient(circle at 85% 25%, rgba(198,216,255,.55), transparent 45%),
                  rgba(255,255,255,.55);
    }
    .heroTitle{
      font-size: 16px;
      font-weight: 1000;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .heroSub{
      margin-top:6px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(27,36,48,.08);
      box-shadow: 0 8px 18px rgba(15,23,42,.05);
      font-weight: 900;
      font-size: 12px;
      color: rgba(27,36,48,.78);
      margin-top: 10px;
    }
    .pillDot{ width:9px; height:9px; border-radius:50%; background: var(--sky); }

    /* Progress ring */
    .ringWrap{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-top: 12px;
    }
    .ring{
      width: 74px; height: 74px;
      border-radius: 50%;
      background:
        conic-gradient(var(--violet) var(--p,0%), rgba(27,36,48,.08) 0);
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.75);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
    }
    .ringInner{
      width: 60px; height: 60px; border-radius: 50%;
      background: rgba(255,255,255,.85);
      display:grid;
      place-items:center;
      border: 1px solid rgba(27,36,48,.08);
      font-weight: 1000;
      font-size: 14px;
    }

    /* Ritual steps */
    .steps{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .step{
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.75);
      background: rgba(255,255,255,.58);
      box-shadow: 0 10px 25px rgba(15,23,42,.08);
      transition: transform .15s ease, background .15s ease, opacity .15s ease;
      position:relative;
    }
    .step.current{
      background: rgba(255,255,255,.86);
      transform: translateY(-1px);
      outline: 2px solid rgba(185,243,228,.55);
    }
    .step.done{
      background: rgba(185,243,228,.42);
      border-color: rgba(43,182,115,.25);
    }
    .stepTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .stepLabel{
      font-weight: 1000;
      font-size: 13px;
      margin:0;
    }
    .stepDesc{
      margin-top:6px;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.3;
    }

    .chip{
      display:inline-flex; align-items:center; gap:7px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(27,36,48,.08);
      background: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 900;
      color: rgba(27,36,48,.72);
      white-space:nowrap;
    }
    .chip.emoji{ background: rgba(198,216,255,.35); }
    .chip.mint{ background: rgba(185,243,228,.35); }
    .chip.sun{ background: rgba(255,211,138,.35); }
    .chip.pink{ background: rgba(255,179,198,.35); }
    .chip.violet{ background: rgba(184,168,255,.32); }

    /* Buttons */
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      font-size: 12.5px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(15,23,42,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease;
    }
    button:active{ transform: scale(.98); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(185,243,228,.95), rgba(198,216,255,.95));
      color: rgba(27,36,48,.90);
      border: 1px solid rgba(255,255,255,.70);
    }
    .btnGhost{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(27,36,48,.10);
      color: rgba(27,36,48,.85);
    }
    .btnDanger{
      background: rgba(255,179,198,.75);
      border: 1px solid rgba(255,179,198,.45);
      color: rgba(27,36,48,.88);
    }

    /* Info tooltip */
    .infoBtn{
      width: 26px; height: 26px; border-radius: 999px;
      display:inline-grid; place-items:center;
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight: 1000;
      color: rgba(27,36,48,.70);
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      flex: 0 0 auto;
    }
    .tip{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(27,36,48,.10);
      color: rgba(27,36,48,.85);
      font-size: 12.5px;
      line-height:1.35;
      box-shadow: 0 10px 25px rgba(15,23,42,.08);
    }

    /* Notes */
    textarea{
      width:100%;
      margin-top:10px;
      padding: 11px 12px;
      border-radius: 16px;
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.75);
      outline:none;
      color: var(--ink);
      min-height: 120px;
      resize: vertical;
      box-shadow: 0 10px 25px rgba(15,23,42,.06);
    }

    /* Calendar */
    .calWrap{ margin-top:12px; }
    .calHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .calTitle{ font-weight: 1000; font-size: 14px; }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .dow{
      text-align:center;
      font-size: 11.5px;
      color: rgba(27,36,48,.55);
      font-weight: 900;
      padding: 4px 0;
    }
    .day{
      border-radius: 16px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(255,255,255,.75);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      padding: 10px 10px 8px;
      min-height: 62px;
      position:relative;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .day:active{ transform: scale(.99); }
    .dayNum{
      font-weight: 1000;
      font-size: 12.5px;
      color: rgba(27,36,48,.80);
    }
    .dots{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:8px;
      align-items:center;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(27,36,48,.16);
      border: 1px solid rgba(255,255,255,.75);
    }
    .dot.am{ background: var(--sun); }
    .dot.pm{ background: var(--sky); }
    .dot.tret{ background: var(--violet); }
    .dot.full{ background: var(--mint); }

    /* Settings */
    .secTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top: 2px;
    }
    .field{
      margin-top: 10px;
    }
    label{
      display:block;
      font-size: 12px;
      font-weight: 950;
      color: rgba(27,36,48,.75);
      margin-bottom: 6px;
    }
    input[type="date"], select{
      width:100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 25px rgba(15,23,42,.06);
      color: var(--ink);
      outline:none;
      font-weight: 850;
    }
    .dayPick{
      display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px;
    }
    .dayBtn{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(27,36,48,.10);
      background: rgba(255,255,255,.65);
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      box-shadow: 0 8px 18px rgba(15,23,42,.05);
    }
    .dayBtn.on{
      background: rgba(185,243,228,.65);
      border-color: rgba(43,182,115,.25);
    }

    /* Product swap cards */
    .prodCard{
      margin-top:10px;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.75);
      background: rgba(255,255,255,.58);
      box-shadow: 0 10px 22px rgba(15,23,42,.07);
    }
    .prodTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .prodName{ font-weight: 1000; font-size: 13px; margin:0; }
    .prodVal{ color: var(--muted); font-size: 12.5px; line-height:1.35; margin-top:6px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11.5px;
      font-weight: 950;
      border: 1px solid rgba(27,36,48,.08);
      background: rgba(255,255,255,.70);
      white-space:nowrap;
    }
    .badge.primary{ background: rgba(198,216,255,.45); }
    .badge.active{ background: rgba(185,243,228,.50); }
    .badge.value{ background: rgba(255,211,138,.40); }

    /* Minimal mode */
    body.minimal .muted,
    body.minimal .stepDesc,
    body.minimal textarea,
    body.minimal .tip{
      display:none !important;
    }

    /* Night background helper */
    body.nightBG{
      background: linear-gradient(135deg, var(--pm1), var(--pm2), var(--pm3));
      color: var(--ink);
    }
  </style>
</head>

<body>
<header>
  <div class="topRow">
    <div class="brand">
      <div class="logoDot"></div>
      <div>Routine ‚ú®</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="toggle" title="Minimal hides descriptions and notes input">
        Minimal
        <div id="minimalSwitch" class="switch" role="switch" aria-checked="false"></div>
      </div>
    </div>
  </div>
  <div class="subtitle">
    Your playful pastel skincare companion. Everything stays on this device (no login, no cloud).
  </div>
  <div class="tabs" id="tabs"></div>
</header>

<main>
  <!-- TODAY -->
  <section id="view-today" class="view">
    <div class="hero" id="hero"></div>

    <div class="grid2" style="margin-top:12px;">
      <div class="card soft">
        <div class="secTitle">
          <div class="h2">Your ritual</div>
          <div class="row">
            <span class="chip emoji" id="chipAM">‚òÄÔ∏è AM</span>
            <span class="chip violet" id="chipPM">üåô PM</span>
          </div>
        </div>

        <div class="ringWrap">
          <div>
            <div class="muted" id="todayHint">Tap ‚ÄúNext‚Äù to flow through steps (like a mini ritual).</div>
            <div class="row" style="margin-top:10px;">
              <span class="chip mint" id="amTypeChip">AM: ‚Äî</span>
              <span class="chip violet" id="pmTypeChip">PM: ‚Äî</span>
            </div>
          </div>
          <div class="ring" id="ring"><div class="ringInner" id="ringPct">0%</div></div>
        </div>

        <div class="actions">
          <button class="btnPrimary" id="btnNext">Next step</button>
          <button class="btnGhost" id="btnMarkAll">Mark today done</button>
          <button class="btnGhost" id="btnClearToday">Clear today</button>
        </div>
      </div>

      <div class="card soft notesCard">
        <div class="secTitle">
          <div class="h2">Notes</div>
          <span class="chip pink">üìù</span>
        </div>
        <div class="muted">Optional: track irritation, melasma changes, breakouts, sun/heat exposure.</div>
        <textarea id="notes" placeholder="Example: slight dryness around nose; no melasma darkening; 1 hormonal pimple on chin."></textarea>
        <div class="actions">
          <button class="btnPrimary" id="btnSaveNotes">Save notes</button>
          <button class="btnGhost" id="btnClearNotes">Clear notes</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="secTitle">
        <div class="h2">Today‚Äôs steps</div>
        <span class="chip sun" id="dateChip">üìÖ</span>
      </div>
      <div class="muted" id="preStartBanner" style="margin-top:6px;"></div>

      <div class="steps" id="steps"></div>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="view-calendar" class="view">
    <div class="card">
      <div class="calHeader">
        <div class="calTitle" id="calTitle">Calendar</div>
        <div class="row">
          <button class="btnGhost" id="calPrev">‚óÄÔ∏é</button>
          <button class="btnGhost" id="calToday">Today</button>
          <button class="btnGhost" id="calNext">‚ñ∂Ô∏é</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <span class="chip sun">üü° AM done</span>
        <span class="chip emoji">üîµ PM done</span>
        <span class="chip violet">üü£ Tret night</span>
        <span class="chip mint">üåø Full day</span>
      </div>

      <div class="calGrid" id="calGrid"></div>

      <div class="tip" id="calTip" style="display:block; margin-top:12px;">
        Tap a date to see what you completed (AM/PM) and whether it was a tret night.
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="view-settings" class="view">
    <div class="card">
      <div class="secTitle">
        <div class="h2">Settings</div>
        <span class="chip emoji">‚öôÔ∏è</span>
      </div>
      <div class="muted">All the ‚Äúlogic‚Äù lives here‚ÄîToday stays calm and simple.</div>

      <div class="field">
        <label for="startDate">Protocol start date (Night 1 = Renewal Night / Tret)</label>
        <input type="date" id="startDate" />
      </div>

      <div class="field">
        <label for="hqPhase">Hydroquinone taper phase</label>
        <select id="hqPhase">
          <option value="phase1">Phase 1 (Month 1): HQ 3 mornings/week</option>
          <option value="phase2">Phase 2 (Month 2): HQ 2 mornings/week</option>
          <option value="phase3">Phase 3 (Month 3+): HQ OFF (maintenance)</option>
        </select>
      </div>

      <div class="field">
        <label>HQ mornings (optional)</label>
        <div class="muted">Pick 3 days for Phase 1 (or 2 days for Phase 2). If you leave it blank, we‚Äôll show general guidance.</div>
        <div class="dayPick" id="hqDays"></div>
        <div class="muted" id="hqHint" style="margin-top:8px;"></div>
      </div>

      <div class="field">
        <label>Products (tap ‚ÄúSwap‚Äù for alternatives)</label>
        <div id="products"></div>
      </div>

      <div class="actions" style="margin-top:14px;">
        <button class="btnPrimary" id="btnSaveSettings">Save settings</button>
        <button class="btnDanger" id="btnReset">Reset app data</button>
      </div>
    </div>
  </section>
</main>

<script>
  window.addEventListener("error", function(e) {
  document.body.insertAdjacentHTML(
    "afterbegin",
    `<div style="
      position:fixed;
      top:10px;
      left:10px;
      right:10px;
      z-index:9999;
      background:#fff3f3;
      border:1px solid #ffb3b3;
      color:#7a0b0b;
      padding:12px;
      border-radius:14px;
      font:14px -apple-system,system-ui;
      box-shadow:0 10px 30px rgba(0,0,0,.12)">
      <b>JS Error:</b> ${e.message}
    </div>`
  );
});

  function deepClone(obj){
  return JSON.parse(JSON.stringify(obj));
}

  // ---------------- State ----------------
  const DEFAULT = {
    settings: {
      rotationStart: new Date().toISOString().slice(0,10),
      hqPhase: "phase1",
      hqDays: [1,3,5], // Mon/Wed/Fri default
      minimalMode: false
    },
    activeProducts: {
      cleanser: "SkinMedica Facial Cleanser",
      vitaminC_HQ: "Obagi Vitamin C + 4% Hydroquinone (AM, tapered)",
      azelaic: "Prescription Azelaic Acid 15% (Finacea or generic)",
      moisturizerLight: "Seacra Marine Algae Gel",
      moisturizerBarrier: "SkinMedica Dermal Repair Cream (PM / retinoid nights)",
      sunscreen: "Eucerin SPF 50",
      tretinoin: "Tretinoin 0.025% cream (Rx)"
    },
    logs: {} // YYYY-MM-DD => { steps:{id:true}, notes:"" }
  };

  // Alternatives (playful + cost/benefit)
  const ALT = {
    cleanser: [
      { name:"SkinMedica Facial Cleanser", tier:"$$", value:"High", note:"Gentle, retinoid-friendly cleanser.", primary:true },
      { name:"La Roche-Posay Toleriane Hydrating Gentle Cleanser", tier:"$", value:"Very High", note:"Best cost/benefit; barrier-friendly." },
      { name:"CeraVe Hydrating Cleanser", tier:"$", value:"High", note:"Very gentle; solid value if you get dry." }
    ],
    azelaic: [
      { name:"Prescription Azelaic Acid 15% (Finacea or generic)", tier:"$$", value:"Very High", note:"Strong maintenance for pigment + acne.", primary:true },
      { name:"Prescription Azelaic Acid 20% cream (generic)", tier:"$$", value:"Very High", note:"Stronger option; discuss with dermatologist." },
      { name:"The Ordinary Azelaic Acid 10% (OTC)", tier:"$", value:"High", note:"Budget option; typically less potent than Rx." }
    ],
    tretinoin: [
      { name:"Tretinoin 0.025% cream (Rx)", tier:"$$", value:"Very High", note:"Gold standard for collagen + acne control.", primary:true },
      { name:"Adapalene 0.1% gel (OTC)", tier:"$", value:"High", note:"Gentler retinoid alternative if needed." },
      { name:"Tretinoin 0.05% cream (Rx)", tier:"$$", value:"High", note:"Step-up after stability on 0.025%." }
    ],
    moisturizerBarrier: [
      { name:"SkinMedica Dermal Repair Cream", tier:"$$$", value:"High", note:"Barrier support for tret nights.", primary:true },
      { name:"La Roche-Posay Cicaplast Balm B5+", tier:"$", value:"Very High", note:"Excellent cost/benefit for irritation." },
      { name:"Obagi Hydrate Luxe (PM)", tier:"$$$", value:"High", note:"Rich PM moisturizer; luxury feel." }
    ],
    moisturizerLight: [
      { name:"Seacra Marine Algae Gel", tier:"$$", value:"Medium", note:"Light hydration layer.", primary:true },
      { name:"Vanicream Daily Facial Moisturizer", tier:"$", value:"High", note:"Simple, low-irritant daily moisturizer." },
      { name:"CeraVe PM Facial Moisturizing Lotion", tier:"$", value:"High", note:"Light but barrier-supportive; solid value." }
    ],
    sunscreen: [
      { name:"Eucerin SPF 50", tier:"$", value:"High", note:"Non-negotiable for melasma stability.", primary:true },
      { name:"EltaMD UV Clear SPF 46", tier:"$$", value:"High", note:"Great for acne-prone + pigmentation-prone skin." },
      { name:"La Roche-Posay Anthelios SPF 50+", tier:"$$", value:"High", note:"Strong UV protection; multiple textures." }
    ]
  };

  // Step ‚Äúwhy‚Äù explanations (brief)
  const WHY = {
    cleanse: "Removes sunscreen/oil gently so actives work better.",
    vitaminC: "Antioxidant + brightening support + collagen friendly.",
    hq: "Targets melasma pigment production (use in cycles/taper).",
    azelaic: "Calms inflammation + supports pigment stability + helps acne.",
    hydrate: "Comfort + barrier support = better tolerance.",
    sunscreen: "Your #1 melasma protector (and wrinkle prevention).",
    wait: "Applying tret on dry skin reduces irritation.",
    tret: "Gold standard for collagen + texture + acne control (start slow).",
    barrier: "Repairs barrier and reduces flaking/irritation."
  };

  const TABS = [
    { id:"today", label:"Today üå∏" },
    { id:"calendar", label:"Calendar üìÖ" },
    { id:"settings", label:"Settings ‚öôÔ∏è" }
  ];

  const $ = (id)=>document.getElementById(id);

  function loadState(){
    try{
      const raw = localStorage.getItem("routine_state_v2");
      return raw ? JSON.parse(raw) : deepClone(DEFAULT);
    } catch {
      return deepClone(DEFAULT);
    }
  }
  function saveState(){
    localStorage.setItem("routine_state_v2", JSON.stringify(state));
  }
  let state = loadState();

  // ---------------- Date helpers ----------------
  function todayISO(){
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  }
  function daysBetween(aISO, bISO){
    const a = new Date(aISO+"T00:00:00");
    const b = new Date(bISO+"T00:00:00");
    return Math.floor((b - a) / (1000*60*60*24));
  }
  function weekdayNum(dateISO){
    return new Date(dateISO+"T00:00:00").getDay(); // 0 Sun..6 Sat
  }
  function isBeforeStart(dateISO){
    return daysBetween(state.settings.rotationStart, dateISO) < 0;
  }

  // ---------------- Protocol logic ----------------
  function nightType(dateISO){
    if(isBeforeStart(dateISO)) return "Prep";
    const delta = daysBetween(state.settings.rotationStart, dateISO);
    const mod = ((delta % 4) + 4) % 4;
    if(mod === 0) return "Renewal";     // Tret
    if(mod === 2) return "Calm+Clear";  // Azelaic
    return "Restore";                  // Recovery
  }

  function hqNeededCount(){
    const p = state.settings.hqPhase;
    if(p==="phase1") return 3;
    if(p==="phase2") return 2;
    return 0;
  }

  function isHQDay(dateISO){
    if(state.settings.hqPhase === "phase3") return false;
    const days = state.settings.hqDays || [];
    if(!Array.isArray(days) || days.length === 0) return null; // not configured
    return days.includes(weekdayNum(dateISO));
  }

  function getLog(dateISO){
    state.logs[dateISO] ||= { steps:{}, notes:"" };
    return state.logs[dateISO];
  }

  // ---------------- Step definitions (guided flow) ----------------
  function buildSteps(dateISO){
    const ap = state.activeProducts;
    const nt = nightType(dateISO);
    const hqDay = isHQDay(dateISO);

    const steps = [];

    // AM steps (always shown as part of "Today")
    steps.push({
      id:"am_cleanse",
      emoji:"üå∏",
      title:"Cleanse",
      detail: ap.cleanser,
      why: WHY.cleanse
    });
    steps.push({
      id:"am_vitc",
      emoji:"üåº",
      title:"Vitamin C",
      detail: ap.vitaminC_HQ + " (Vitamin C part daily)",
      why: WHY.vitaminC
    });

    if(state.settings.hqPhase !== "phase3"){
      if(hqDay === true){
        steps.push({
          id:"am_hq",
          emoji:"‚ú®",
          title:"Brightening step (HQ day)",
          detail:"Hydroquinone 4% (taper). Use only today if it‚Äôs one of your HQ mornings.",
          why: WHY.hq
        });
      } else if(hqDay === false){
        steps.push({
          id:"am_az",
          emoji:"üåø",
          title:"Brightening step (Azelaic today)",
          detail: ap.azelaic,
          why: WHY.azelaic
        });
      } else {
        // Not configured: show both with friendly guidance
        steps.push({
          id:"am_hq",
          emoji:"‚ú®",
          title:"Brightening step (HQ taper)",
          detail:"HQ on scheduled mornings (Phase: " + state.settings.hqPhase + ").",
          why: WHY.hq
        });
        steps.push({
          id:"am_az",
          emoji:"üåø",
          title:"Brightening step (Azelaic on non-HQ mornings)",
          detail: ap.azelaic,
          why: WHY.azelaic
        });
      }
    } else {
      steps.push({
        id:"am_az",
        emoji:"üåø",
        title:"Azelaic (maintenance)",
        detail: ap.azelaic,
        why: WHY.azelaic
      });
    }

    steps.push({
      id:"am_hydrate",
      emoji:"üíß",
      title:"Hydrate",
      detail: ap.moisturizerLight,
      why: WHY.hydrate
    });

    steps.push({
      id:"am_spf",
      emoji:"‚òÄÔ∏è",
      title:"Sunscreen",
      detail: ap.sunscreen + " (2 finger lengths)",
      why: WHY.sunscreen
    });

    // PM steps (vary by rotation, but still shown on same screen)
    if(nt === "Prep"){
      steps.push({
        id:"pm_cleanse",
        emoji:"üåô",
        title:"Evening cleanse",
        detail: ap.cleanser,
        why: WHY.cleanse
      });
      steps.push({
        id:"pm_restore",
        emoji:"üíú",
        title:"Moisturize (prep mode)",
        detail: "Use " + ap.moisturizerLight + " (add barrier cream if dry). No tret until start date.",
        why: WHY.barrier
      });
      return steps;
    }

    if(nt === "Renewal"){
      steps.push({ id:"pm_cleanse", emoji:"üåô", title:"Evening cleanse", detail: ap.cleanser, why: WHY.cleanse });
      steps.push({ id:"pm_wait", emoji:"‚è≥", title:"Let skin dry (20 min)", detail:"Optional timer available.", why: WHY.wait, timer: true });
      steps.push({ id:"pm_tret", emoji:"üåü", title:"Renewal cream (tret)", detail: ap.tretinoin + " (pea size)", why: WHY.tret });
      steps.push({ id:"pm_barrier", emoji:"ü´∂", title:"Barrier repair", detail: ap.moisturizerBarrier, why: WHY.barrier });
    } else if(nt === "Calm+Clear"){
      steps.push({ id:"pm_cleanse", emoji:"üåô", title:"Evening cleanse", detail: ap.cleanser, why: WHY.cleanse });
      steps.push({ id:"pm_az", emoji:"üåø", title:"Calm + clear (azelaic)", detail: ap.azelaic, why: WHY.azelaic });
      steps.push({ id:"pm_moist", emoji:"üíú", title:"Moisturize", detail: ap.moisturizerBarrier + " (or gel if not dry)", why: WHY.barrier });
    } else {
      steps.push({ id:"pm_cleanse", emoji:"üåô", title:"Evening cleanse", detail: ap.cleanser, why: WHY.cleanse });
      steps.push({ id:"pm_restore", emoji:"üíú", title:"Restore night", detail: "Moisturize only (barrier cream if dry/flaky).", why: WHY.barrier });
    }

    return steps;
  }

  function labelAM(dateISO){
    if(state.settings.hqPhase === "phase3") return "Azelaic day";
    const hq = isHQDay(dateISO);
    if(hq === true) return "HQ day";
    if(hq === false) return "Azelaic day";
    return "Taper guidance";
  }

  function labelPM(dateISO){
    const nt = nightType(dateISO);
    if(nt === "Prep") return "Prep mode";
    if(nt === "Renewal") return "Renewal night (tret)";
    if(nt === "Calm+Clear") return "Calm + clear night";
    return "Restore night";
  }

  // ---------------- UI: Tabs ----------------
  function renderTabs(active){
    const el = $("tabs");
    el.innerHTML = "";
    TABS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (t.id === active ? " active" : "");
      b.textContent = t.label;
      b.onclick = ()=>showView(t.id);
      el.appendChild(b);
    });
  }

  function showView(id){
    ["today","calendar","settings"].forEach(v=>{
      const el = document.querySelector("#view-"+v);
      if(v === id){
        el.style.display = "";
        requestAnimationFrame(()=>el.classList.add("active"));
      } else {
        el.classList.remove("active");
        setTimeout(()=>{ el.style.display = "none"; }, 180);
      }
    });
    renderTabs(id);
  }

  // ---------------- UI: Minimal mode ----------------
  function applyMinimal(){
    document.body.classList.toggle("minimal", !!state.settings.minimalMode);
    const sw = $("minimalSwitch");
    sw.classList.toggle("on", !!state.settings.minimalMode);
    sw.setAttribute("aria-checked", state.settings.minimalMode ? "true":"false");
  }

  // ---------------- UI: Today render ----------------
  function setBackgroundFor(dateISO){
    const nt = nightType(dateISO);
    // Night background if it's after start and it's a night with actives OR just always keep morning? We'll switch when PM is "Renewal/Calm/Restore"
    const nightish = (nt !== "Prep"); // once started, use night gradient for a cozy feel
    document.body.classList.toggle("nightBG", nightish);
  }

  function renderHero(dateISO){
    const h = $("hero");
    const nt = nightType(dateISO);

    const greeting = (new Date().getHours() < 15) ? "Good Morning" : "Good Evening";
    const vibe =
      nt === "Prep" ? "Prep mode until your start date üíõ" :
      nt === "Renewal" ? "Tonight is Renewal Night ‚ú®" :
      nt === "Calm+Clear" ? "Tonight is Calm + Clear üåø" :
      "Tonight is Restore + Repair üíú";

    const start = state.settings.rotationStart;
    const pre = isBeforeStart(dateISO);

    h.innerHTML = `
      <div class="heroTitle">${greeting} ‚ú®</div>
      <div class="heroSub">${vibe}</div>
      <div class="row">
        <div class="pill"><span class="pillDot"></span>Today: <strong>${dateISO}</strong></div>
        <div class="pill"><span class="pillDot" style="background: var(--mint)"></span>Start date: <strong>${start}</strong></div>
        ${pre ? `<div class="pill"><span class="pillDot" style="background: var(--sun)"></span>Prep mode</div>` : ``}
      </div>
    `;
  }

  function computeProgress(dateISO, steps){
    const log = getLog(dateISO).steps;
    const total = steps.length;
    const done = steps.reduce((acc,s)=>acc + (log[s.id] ? 1 : 0), 0);
    const pct = total ? Math.round((done/total)*100) : 0;
    return { total, done, pct };
  }

  function toggleTip(id){
    if(document.body.classList.contains("minimal")) return;
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display = el.style.display === "block" ? "none" : "block";
  }
  window.toggleTip = toggleTip;

  function renderSteps(dateISO){
    const wrap = $("steps");
    const steps = buildSteps(dateISO);
    const log = getLog(dateISO).steps;

    // Determine current step = first not done
    let currentIndex = steps.findIndex(s => !log[s.id]);
    if(currentIndex === -1) currentIndex = steps.length - 1;

    wrap.innerHTML = "";

    steps.forEach((s, idx)=>{
      const tipId = `tip_${dateISO}_${s.id}`.replaceAll("-","_");

      const div = document.createElement("div");
      div.className = "step" + (idx===currentIndex ? " current" : "") + (log[s.id] ? " done" : "");
      div.innerHTML = `
        <div class="stepTop">
          <div>
            <div class="row" style="gap:10px;">
              <span class="chip emoji">${s.emoji} Step ${idx+1}</span>
              <div class="stepLabel">${escapeHtml(s.title)}</div>
            </div>
            <div class="stepDesc">${escapeHtml(s.detail)}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="infoBtn" onclick="toggleTip('${tipId}')" title="What does this do?">?</div>
            <button class="btnGhost" style="padding:8px 10px; border-radius:12px; box-shadow:none;"
              onclick="toggleStep('${dateISO}','${s.id}')">${log[s.id] ? "Undo" : "Done"}</button>
          </div>
        </div>

        <div class="tip" id="${tipId}">
          <strong>Why:</strong> ${escapeHtml(s.why || "")}
          ${s.timer ? `<div style="margin-top:8px;"><button class="btnPrimary" style="padding:8px 10px; border-radius:12px; box-shadow:none;" onclick="startTimer(20)">Start 20-min timer</button> <span class="muted" id="timerLabel"></span></div>` : ``}
        </div>
      `;
      wrap.appendChild(div);
    });

    // Chips for AM/PM types + progress ring
    $("amTypeChip").textContent = `AM: ${labelAM(dateISO)}`;
    $("pmTypeChip").textContent = `PM: ${labelPM(dateISO)}`;

    const prog = computeProgress(dateISO, steps);
    $("ring").style.setProperty("--p", prog.pct + "%");
    $("ringPct").textContent = prog.pct + "%";

    // Pre-start banner text
    const pre = $("preStartBanner");
    if(isBeforeStart(dateISO)){
      pre.textContent = `Prep mode: your protocol starts on ${state.settings.rotationStart}. Until then, keep it gentle at night (moisturize only) and be consistent with SPF in the morning.`;
    } else {
      pre.textContent = "";
    }

    return { steps, currentIndex, prog };
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  window.toggleStep = function(dateISO, stepId){
    const log = getLog(dateISO).steps;
    log[stepId] = !log[stepId];
    saveState();
    renderToday();
  };

  function renderToday(){
    const dateISO = todayISO();
    setBackgroundFor(dateISO);
    renderHero(dateISO);
    const { steps } = renderSteps(dateISO);

    // Notes
    $("notes").value = getLog(dateISO).notes || "";

    // update chips in hero card (AM/PM chip labels already set)
    $("dateChip").textContent = "üìÖ " + dateISO;

    // If fully complete, show gentle message in hint
    const prog = computeProgress(dateISO, steps);
    $("todayHint").textContent = prog.pct === 100 ? "Ritual complete ‚ú®‚ú®‚ú®" : "Tap ‚ÄúNext step‚Äù to flow through steps (like a mini ritual).";
  }

  // Guided flow: Next step
  function nextStep(){
    const dateISO = todayISO();
    const steps = buildSteps(dateISO);
    const log = getLog(dateISO).steps;
    const idx = steps.findIndex(s => !log[s.id]);
    if(idx === -1){
      // already done
      return;
    }
    log[steps[idx].id] = true;
    saveState();
    renderToday();

    // Light feedback animation: scroll current step into view
    const wrap = $("steps");
    const el = wrap.children[Math.min(idx+1, wrap.children.length-1)];
    if(el && el.scrollIntoView) el.scrollIntoView({ behavior:"smooth", block:"center" });
  }

  function markAll(){
    const dateISO = todayISO();
    const steps = buildSteps(dateISO);
    const log = getLog(dateISO).steps;
    steps.forEach(s=> log[s.id] = true);
    saveState();
    renderToday();
  }

  function clearToday(){
    const dateISO = todayISO();
    const keepNotes = getLog(dateISO).notes || "";
    state.logs[dateISO] = { steps:{}, notes: keepNotes };
    saveState();
    renderToday();
  }

  // Simple 20-min timer (in-app label)
  let timerInt = null;
  function startTimer(mins){
    const total = mins * 60;
    let left = total;
    const label = document.getElementById("timerLabel");
    if(timerInt) clearInterval(timerInt);

    const fmt = (s)=>{
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    };
    if(label) label.textContent = ` (${fmt(left)})`;

    timerInt = setInterval(()=>{
      left--;
      if(label) label.textContent = ` (${fmt(Math.max(left,0))})`;
      if(left <= 0){
        clearInterval(timerInt);
        timerInt = null;
        if(label) label.textContent = " (done ‚ú®)";
        // gentle notification alternative: just update text (no permissions)
      }
    }, 1000);
  }
  window.startTimer = startTimer;

  // ---------------- Calendar ----------------
  const DOW = ["S","M","T","W","T","F","S"];
  let calMonth = null; // Date object at first of month

  function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

  function renderCalendar(){
    const now = new Date();
    if(!calMonth) calMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    const title = calMonth.toLocaleString(undefined, { month:"long", year:"numeric" });
    $("calTitle").textContent = title;

    const grid = $("calGrid");
    grid.innerHTML = "";

    // DOW header
    DOW.forEach(x=>{
      const d = document.createElement("div");
      d.className = "dow";
      d.textContent = x;
      grid.appendChild(d);
    });

    const firstDay = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1);
    const startDow = firstDay.getDay();
    const daysInMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0).getDate();

    // blanks
    for(let i=0;i<startDow;i++){
      const blank = document.createElement("div");
      blank.style.opacity = "0";
      grid.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(calMonth.getFullYear(), calMonth.getMonth(), day);
      const iso = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
      const log = state.logs[iso]?.steps || {};
      const steps = buildSteps(iso);
      const prog = computeProgress(iso, steps);

      // heuristics: AM done if first ~AM steps done (we'll check key AM ids)
      const amDone = !!(log["am_cleanse"] && log["am_spf"]); // practical
      const pmDone = !!(log["pm_cleanse"] && (log["pm_barrier"] || log["pm_restore"] || log["pm_moist"] || log["pm_tret"] || log["pm_az"]));
      const isTret = (nightType(iso) === "Renewal") && !isBeforeStart(iso);
      const full = (prog.pct === 100);

      const cell = document.createElement("div");
      cell.className = "day";
      cell.innerHTML = `
        <div class="dayNum">${day}</div>
        <div class="dots">
          ${amDone ? `<span class="dot am" title="AM done"></span>` : ``}
          ${pmDone ? `<span class="dot pm" title="PM done"></span>` : ``}
          ${isTret ? `<span class="dot tret" title="Tret night"></span>` : ``}
          ${full ? `<span class="dot full" title="Full day"></span>` : ``}
        </div>
      `;
      cell.onclick = ()=>{
        const msg = [];
        msg.push(`Date: ${iso}`);
        msg.push(`AM: ${amDone ? "Done üü°" : "‚Äî"}`);
        msg.push(`PM: ${pmDone ? "Done üîµ" : "‚Äî"}`);
        msg.push(`Night: ${labelPM(iso)}${isTret ? " üü£" : ""}`);
        msg.push(`Progress: ${prog.pct}%`);
        alert(msg.join("\n"));
      };

      grid.appendChild(cell);
    }
  }

  // ---------------- Settings: HQ day picker ----------------
  const DAY_NAMES = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function renderHQDays(){
    const wrap = $("hqDays");
    wrap.innerHTML = "";
    const selected = new Set(state.settings.hqDays || []);
    DAY_NAMES.forEach((n, idx)=>{
      const b = document.createElement("button");
      b.type="button";
      b.className = "dayBtn" + (selected.has(idx) ? " on" : "");
      b.textContent = selected.has(idx) ? `${n} ‚úì` : n;
      b.onclick = ()=>{
        const s = new Set(state.settings.hqDays || []);
        if(s.has(idx)) s.delete(idx); else s.add(idx);
        state.settings.hqDays = Array.from(s).sort((a,b)=>a-b);
        saveState();
        renderHQDays();
        renderHQHint();
        renderToday();
      };
      wrap.appendChild(b);
    });
    renderHQHint();
  }

  function renderHQHint(){
    const needed = hqNeededCount();
    const count = (state.settings.hqDays || []).length;
    let msg = "";
    if(needed === 0){
      msg = "HQ is off in Phase 3. (Day selection doesn‚Äôt matter.)";
    } else if(count === 0){
      msg = `Tip: pick ${needed} days for HQ so Today can label HQ vs Azelaic mornings.`;
    } else {
      msg = `Selected ${count} day(s). Recommended: select exactly ${needed} for this phase.`;
    }
    $("hqHint").textContent = msg;
  }

  // ---------------- Settings: products + swapping ----------------
  function renderProducts(){
    const wrap = $("products");
    wrap.innerHTML = "";

    const sections = [
      { key:"cleanser", title:"Cleanser ü´ß" },
      { key:"vitaminC_HQ", title:"Vitamin C + HQ (AM serum) üçä" , locked:true },
      { key:"azelaic", title:"Azelaic üåø" },
      { key:"tretinoin", title:"Renewal cream (tret) üåü" },
      { key:"moisturizerLight", title:"Hydration gel üíß" },
      { key:"moisturizerBarrier", title:"Barrier repair üíú" },
      { key:"sunscreen", title:"Sunscreen ‚òÄÔ∏è" }
    ];

    sections.forEach(sec=>{
      const current = state.activeProducts[sec.key] || "";
      const card = document.createElement("div");
      card.className = "prodCard";

      const topBadges = `
        <span class="badge active">Active</span>
        ${sec.locked ? `<span class="badge value">Locked</span>` : ``}
      `;

      card.innerHTML = `
        <div class="prodTop">
          <div style="min-width:0;">
            <div class="prodName">${escapeHtml(sec.title)}</div>
            <div class="prodVal">${escapeHtml(current)}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            ${topBadges}
            ${sec.locked ? "" : `<button class="btnGhost" style="padding:8px 10px; border-radius:12px; box-shadow:none;" data-swap="${sec.key}">Swap</button>`}
          </div>
        </div>
        <div class="tip" id="swap_${sec.key}" style="display:none;"></div>
      `;
      wrap.appendChild(card);

      if(!sec.locked){
        const btn = card.querySelector(`[data-swap="${sec.key}"]`);
        btn.onclick = ()=>{
          const tip = card.querySelector(`#swap_${sec.key}`);
          const show = tip.style.display !== "block";
          tip.style.display = show ? "block" : "none";
          if(show){
            tip.innerHTML = renderSwapList(sec.key);
          }
        };
      }
    });
  }

  function renderSwapList(key){
    const list = ALT[key];
    if(!list) return `<div class="muted">No alternatives configured.</div>`;

    return `
      <div class="muted" style="margin-bottom:8px;">Pick a replacement (value = cost/benefit).</div>
      ${list.map(item=>{
        const active = state.activeProducts[key] === item.name;
        return `
          <div class="prodCard" style="margin-top:8px; background: rgba(255,255,255,.70); box-shadow:none;">
            <div class="prodTop">
              <div style="min-width:0;">
                <div class="prodName">${escapeHtml(item.name)}</div>
                <div class="prodVal">${escapeHtml(item.note)}</div>
                <div class="row" style="margin-top:8px;">
                  ${item.primary ? `<span class="badge primary">Primary</span>` : `<span class="badge">Alt</span>`}
                  <span class="badge value">${escapeHtml(item.tier)} ‚Ä¢ Value: ${escapeHtml(item.value)}</span>
                  ${active ? `<span class="badge active">Active</span>` : ``}
                </div>
              </div>
              <div>
                ${active ? `<button class="btnGhost" style="padding:8px 10px; border-radius:12px; box-shadow:none; opacity:.6;" disabled>Active</button>`
                         : `<button class="btnPrimary" style="padding:8px 10px; border-radius:12px; box-shadow:none;" onclick="swapNow('${key}','${escapeHtml(item.name).replaceAll("'", "&#39;")}')">Use</button>`}
              </div>
            </div>
          </div>
        `;
      }).join("")}
    `;
  }

  window.swapNow = function(key, name){
    // unescape basic html entity if any
    const decoded = name.replaceAll("&#39;","'");
    state.activeProducts[key] = decoded;
    saveState();
    renderProducts();
    renderToday();
  };

  // ---------------- Events ----------------
  function wire(){
    // minimal toggle
    $("minimalSwitch").onclick = ()=>{
      state.settings.minimalMode = !state.settings.minimalMode;
      saveState();
      applyMinimal();
    };

    // today actions
    $("btnNext").onclick = nextStep;
    $("btnMarkAll").onclick = markAll;
    $("btnClearToday").onclick = clearToday;

    $("btnSaveNotes").onclick = ()=>{
      const iso = todayISO();
      getLog(iso).notes = $("notes").value || "";
      saveState();
      renderToday();
    };
    $("btnClearNotes").onclick = ()=>{
      const iso = todayISO();
      getLog(iso).notes = "";
      saveState();
      renderToday();
    };

    // calendar nav
    $("calPrev").onclick = ()=>{
      calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1);
      renderCalendar();
    };
    $("calNext").onclick = ()=>{
      calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1);
      renderCalendar();
    };
    $("calToday").onclick = ()=>{
      const now = new Date();
      calMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      renderCalendar();
    };

    // settings
    $("btnSaveSettings").onclick = ()=>{
      state.settings.rotationStart = $("startDate").value || todayISO();
      state.settings.hqPhase = $("hqPhase").value || "phase1";
      saveState();
      renderHQDays();
      renderToday();
      alert("Saved ‚ú®");
    };

    $("btnReset").onclick = ()=>{
      if(confirm("Reset all saved routine data on this device?")){
        localStorage.removeItem("routine_state_v2");
        state = deepClone(DEFAULT);
        saveState();
        applyMinimal();
        renderAll();
        alert("Reset done.");
      }
    };
  }

  // ---------------- Render all ----------------
  function renderSettings(){
    $("startDate").value = state.settings.rotationStart;
    $("hqPhase").value = state.settings.hqPhase;
    renderHQDays();
    renderProducts();
  }

  function renderAll(){
    applyMinimal();
    renderToday();
    renderCalendar();
    renderSettings();
  }

  // Service worker (offline)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }

  // Init
  renderTabs("today");
  showView("today");
  renderAll();
  wire();
</script>
</body>
</html>
